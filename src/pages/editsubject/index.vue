<template>
  <view class="page">
    <title-bar :title="survey.title"/>
    <view class="content">
    <scoll-view scroll-y='true' class="scroll-style">
      <view class="weui-cells__title">标题</view>
      <view class="weui-cells weui-cells_after-title">
        <view class="weui-cell">
          <view class="weui-cell__bd">
            <text-or-area :content="subject.question"  @getTextareaValue="updateTitleValue" :defaultValue="'请填写内容'"></text-or-area>
          </view>
        </view>
        <view class="weui-cell">
          <mediaBox :data="subject" @inputUrl="getSourseUrl" @chooseVideo="chooseTitleVideo"  @chooseImage="chooseTitleImage" @choosePoster="choosePoster" @deleteMedia="deleteMedia" @setAudioName="setAudioName" @setAudioAuthor="setAudioAuthor" @setPoster="setPoster"/>
        </view>
        <view class="weui-cell weui-cell_input weui-cell_warn" v-if="!isLegal">
          <view class="weui-cell__bd">
            标题: 文字和图片不能同时为空
          </view>
          <view class="weui-cell__ft">
              <icon type="warn" size="15" color="#E64340"></icon>
          </view>
        </view>
        <view class="weui-cell weui-cell_select">
          <view class="weui-cell__hd weui-cell__hd_in-select-after">
              <view class="weui-label">类型</view>
          </view>
          <view class="weui-cell__bd">
            <picker @change="subjectTypeChange" :value="typeIndex" :range="typeNameRange">
              <view class="weui-select weui-select_in-select-after">{{typeNameRange[typeIndex]}}</view>
            </picker>
          </view>
        </view>
      </view>
      <view class="weui-cells__title">选项</view>
      <edit-answer :survey="survey" :subject="subject" @input="answerChange"/>
      <view class="weui-cell weui-cell_input weui-cell_warn" v-if="!answersLegal">
          <view class="weui-cell__bd">
            {{inlegalText}}
          </view>
          <view class="weui-cell__ft">
              <icon type="warn" size="15" color="#E64340"></icon>
          </view>
      </view>
    </scoll-view>
    </view>
    <view class="footer bottom_button">
      <button class="weui-btn" type="primary" @tap="saveSubject">保存</button>
    </view>
  </view>
</template>

<script>
import { mapState } from 'vuex'
import editAnswer from '@/components/editAnswer'
import textOrArea from '@/components/textOrArea'
import imageUploader from '@/components/widget/imageUploader'
import videoUploader from '@/components/widget/videoUploader'
import switchBar from '@/components/widget/switchBar'
import mediaBox from '@/components/widget/mediaBox'

const subjectType = ['radio', 'checkbox', 'text', 'date', 'location', 'phone']
const subjectTypeName = ['单选', '多选', '问答', '日期', '地点', '手机']

export default {
  data: {
    subject: {},
    typeRange: subjectType,
    typeNameRange: subjectTypeName,
    typeIndex: -1,
    isLegal: true,
    answersLegal: true,
    inlegalText: ''
  },
  computed: {
    ...mapState({
      survey: state => state.curSurvey.survey
    }),
    error () {
      if (this.subject.question === '' && this.subject.imageUrl === '') {
        return true
      }

      let answerError = false
      this.subject.answers.map((answer) => {
        if (answer.value === '' && answer.imageUrl === '') {
          answerError = true
        }
      })
      return answerError
    }
  },
  components: {
    editAnswer,
    textOrArea,
    imageUploader,
    videoUploader,
    switchBar,
    mediaBox
  },
  methods: {
    switchState (state) {
      this.switchOn = state
    },
    updateTitleValue (event) {
      console.log(event)
      this.subject.question = event.value
      this.verifySubject()
    },
    deleteMedia (state) {
      this.subject.imageUrl = ''
      this.subject.urlType = ''
      if (this.subject.mediaInfo) {
        this.subject.mediaInfo.poster = ''
        this.subject.mediaInfo.name = ''
        this.subject.mediaInfo.author = ''
      }
      this.verifySubject()
    },
    chooseTitleImage (url) {
      this.subject.imageUrl = url
      this.subject.urlType = 'image'
      this.verifySubject()
    },
    chooseTitleVideo (url) {
      this.subject.imageUrl = url
      this.subject.urlType = 'video'
      this.verifySubject()
    },
    choosePoster (poster) {
      this.subject.mediaInfo = this.subject.mediaInfo ? this.subject.mediaInfo : {}
      this.subject = {...this.subject, mediaInfo: {...this.subject.mediaInfo, poster: poster}}
    },
    setAudioName (name) {
      this.subject.mediaInfo = this.subject.mediaInfo ? this.subject.mediaInfo : {}
      this.subject = {...this.subject, mediaInfo: {...this.subject.mediaInfo, name: name}}
    },
    setAudioAuthor (author) {
      this.subject.mediaInfo = this.subject.mediaInfo ? this.subject.mediaInfo : {}
      this.subject = {...this.subject, mediaInfo: {...this.subject.mediaInfo, author: author}}
    },
    setPoster (poster) {
      this.subject.mediaInfo = this.subject.mediaInfo ? this.subject.mediaInfo : {}
      this.subject = {...this.subject, mediaInfo: {...this.subject.mediaInfo, poster: poster}}
    },
    getSourseUrl (url, state) {
      this.subject.imageUrl = url
      this.verifySubject()
      switch (state) {
        case 1:
          this.subject.urlType = 'image'
          break
        case 2:
          this.subject.urlType = 'video'
          break
        case 3:
          this.subject.urlType = 'audio'
          break
      }
    },
    subjectTypeChange (event) {
      this.typeIndex = event.mp.detail.value
      let type = this.typeRange[this.typeIndex]
      var oldType = this.subject.type
      if (type === 'date' || type === 'phone' || type === 'location') {
        if (oldType !== type) {
          this.subject.answers = []
          this.subject.type = type
        }
        return
      }

      if (type === 'radio' && oldType !== 'radio') {
        var findFirstRadio = false
        var answers = this.subject.answers
        answers = answers.map((answer) => {
          if (answer.correct && !findFirstRadio) {
            findFirstRadio = true
          } else {
            answer.correct = false
          }
          return answer
        })
        this.subject.answers = answers
      }
      this.subject.type = type
      this.subject.nlu = type === 'date'
    },
    answerChange (event) {
      this.subject.answers = event
      console.log(this.subject.answers)
    },

    verifySubject () {
      this.isLegal = this.subject.question !== '' || this.subject.imageUrl !== ''
      if (!this.isLegal) {
        wx.showModal({
          title: '请检查问卷',
          content: '文字和图片不能同时为空',
          showCancel: false
        })
      }
    },

    verifyAnswer (answer) {
      if (this.subject.type === 'phone') {
        let reg = /^([1-9][0-9]{10})/
        answer.islegal = reg.test(answer.value)
        console.log('test result=>', answer.islegal)
        answer.verifyResult = (answer.islegal) ? '' : '手机号码的正确格式为11位数字'
      } else {
        answer.islegal = answer.value !== '' || answer.imageUrl !== ''
        answer.verifyResult = (answer.islegal) ? '' : '答案: 文字和图片不能同时为空'
      }
      if (!answer.isLegal) {
        wx.showModal({
          title: '请检查问卷',
          content: answer.verifyResult,
          showCancel: false
        })
      }
    },

    hasCorrectAnswer () {
      let correctAnswer = this.subject.answers.find(answer => {
        return answer.correct === true
      })
      return correctAnswer != null
    },

    verifyAnswers () {
      let ret = true
      if (this.subject.type === 'radio') {
        this.answersLegal = this.subject.answers.length >= 1
        this.inlegalText = '单选题最少要配置一个选项'
      } else if (this.subject.type === 'checkbox') {
        this.answersLegal = this.subject.answers.length >= 2
        this.inlegalText = '多选题最少要配置两个选项'
      } else {
        this.answersLegal = true
        this.inlegalText = ''
      }
      if (!this.answersLegal) {
        wx.showModal({
          title: '请检查问卷',
          content: this.inlegalText,
          showCancel: false
        })
        return false
      } else if (this.survey.type === 'exam') {
        if (!this.hasCorrectAnswer()) {
          this.answersLegal = false
          this.inlegalText = '没有有效的正确答案'
        }
        if (!this.answersLegal) {
          wx.showModal({
            title: '请检查问卷',
            content: this.inlegalText,
            showCancel: false
          })
          return false
        }
      }

      this.subject.answers.forEach(answer => {
        this.verifyAnswer(answer)
        ret = ret & answer.islegal
      })
      return ret
    },

    saveSubject () {
      this.verifySubject()
      let answerLegal = this.verifyAnswers()
      if (!this.isLegal || !answerLegal) {
        console.log('subject question is in legal')
        return
      }
      const option = this.$root.$mp.query
      if (option.action === 'create') {
        this.$store.commit('appendCurSubject', this.subject)
      } else {
        this.$store.commit('updateCurSubject', {index: option.subject, subject: this.subject})
      }
      console.log(this.survey)
      this.$store.dispatch('saveCurSurvey', this.survey)
        .then(() => {
          wx.navigateBack()
        })
    }
  },
  onLoad (option) {
    if (!option.action) {
      console.error('need to set parameter')
    }
    if (option.action === 'create') {
      this.subject = {
        type: 'radio',
        question: '',
        imageUrl: '',
        urlType: '',
        answers: [],
        MediaInfo: {}
      }
    } else {
      this.subject = JSON.parse(JSON.stringify(this.survey.subjects[option.subject]))
    }

    this.typeIndex = this.typeRange.indexOf(this.subject.type)
    this.isLegal = true
    this.answersLegal = true
  },
  onShareAppMessage: function () {
    return {
      title: '',
      path: '/pages/index/main'
    }
  }
}
</script>

<style lang="less" scoped>
@import '../../../static/base.less';
.weui-select {
  border-right: none!important;
  text-align: center;
}

.weui-label {
  color: #999;
}

.content {
  width: 100%
}

.scroll-style{
  height: 100%;
  width: 100%;
  overflow: auto;
}

.footer {
  margin-top: 20rpx;
  margin-bottom: 20rpx;
}

.weui-cell_warn {
  font-size: 24rpx;
}


</style>
